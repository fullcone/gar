# This file should be placed in fullcone/gar repo at .github/workflows/merge.yml
# Receives trigger from private repo, downloads components, merges, encrypts, updates Release

name: Merge Build

on:
  repository_dispatch:
    types: [merge-build]

jobs:
  merge:
    name: 'Merge and Encrypt'
    runs-on: ubuntu-24.04
    steps:
      - name: Show build info
        run: |
          echo "Release ID: ${{ github.event.client_payload.release_id }}"
          echo "Release Tag: ${{ github.event.client_payload.release_tag }}"
          echo "Run Number: ${{ github.event.client_payload.run_number }}"
          echo "ReHLDS: ${{ github.event.client_payload.rehlds_version }}"
          echo "ReGameDLL: ${{ github.event.client_payload.regamedll_version }}"
          echo "Metamod-R: ${{ github.event.client_payload.metamod_version }}"
          echo "ReAPI: ${{ github.event.client_payload.reapi_version }}"
          echo "ReUnion: ${{ github.event.client_payload.reunion_version }}"
          echo "ReVoice: ${{ github.event.client_payload.revoice_version }}"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full jq curl unzip

      - name: Download all component zips from Release
        env:
          GAR_REPO_TOKEN: ${{ secrets.GAR_REPO_TOKEN }}
        run: |
          RELEASE_TAG="${{ github.event.client_payload.release_tag }}"
          
          # Get all Release assets
          ASSETS=$(curl -s \
            -H "Authorization: token $GAR_REPO_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/fullcone/gar/releases/tags/$RELEASE_TAG" \
            | jq -r '.assets[] | "\(.name) \(.browser_download_url)"')
          
          mkdir -p downloads
          
          # Download all component zips (excluding source)
          echo "$ASSETS" | while read name url; do
            if [[ "$name" == *".zip" ]] && [[ "$name" != *"-source.zip" ]]; then
              echo "Downloading $name..."
              curl -sL -H "Authorization: token $GAR_REPO_TOKEN" "$url" -o "downloads/$name"
            fi
          done
          
          # Download all source zips
          mkdir -p source-downloads
          echo "$ASSETS" | while read name url; do
            if [[ "$name" == *"-source.zip" ]]; then
              echo "Downloading $name..."
              curl -sL -H "Authorization: token $GAR_REPO_TOKEN" "$url" -o "source-downloads/$name"
            fi
          done
          
          echo "Downloaded files:"
          ls -la downloads/
          ls -la source-downloads/

      - name: Extract and merge components
        run: |
          mkdir -p merged/cstrike
          
          # Extract ReHLDS (top-level files)
          if [ -f downloads/rehlds.zip ]; then
            unzip -o downloads/rehlds.zip -d merged/
          fi
          
          # Extract other components to cstrike
          for zip in regamedll metamod reapi reunion revoice amxxeasyhttp; do
            if [ -f "downloads/${zip}.zip" ]; then
              unzip -o "downloads/${zip}.zip" -d temp_extract/
              if [ -d temp_extract/cstrike ]; then
                rsync -a temp_extract/cstrike/ merged/cstrike/
              fi
              rm -rf temp_extract
            fi
          done
          
          # AMX Mod X special handling
          if [ -f downloads/amxmodx.zip ]; then
            unzip -o downloads/amxmodx.zip -d amxmodx_temp/
            cd amxmodx_temp
            # Save other game directories to source (not in all-in-one)
            mkdir -p ../amxmodx_other_games
            for game in dod esf ns tfc ts; do
              [ -d "$game" ] && mv "$game" ../amxmodx_other_games/
            done
            # Keep license files (do not delete)
            # Merge base and cstrike
            if [ -d "base/addons" ] && [ -d "cstrike/addons" ]; then
              rsync -a base/addons/ cstrike/addons/ --ignore-existing
            fi
            # Copy to merged (including base license files)
            if [ -d cstrike ]; then
              rsync -a cstrike/ ../merged/cstrike/
            fi
            # Copy base directory license files to merged root
            if [ -d base ]; then
              find base -maxdepth 1 -name "*.txt" -exec cp {} ../merged/ \;
            fi
            cd ..
            rm -rf amxmodx_temp
          fi
          
          # Generate plugins.ini
          {
            echo "; Metamod plugins.ini"
            echo "linux addons/amxmodx/dlls/amxmodx_mm_i386.so"
            echo "linux addons/reunion/reunion_mm_i386.so"
            echo "linux addons/revoice/revoice_mm_i386.so"
          } > merged/cstrike/addons/metamod/plugins.ini
          
          # Generate liblist.gam
          {
            echo 'game "Counter-Strike"'
            echo 'url_info "www.counter-strike.net"'
            echo 'url_dl ""'
            echo 'version "1.6"'
            echo 'size "184000000"'
            echo 'svonly "0"'
            echo 'secure "1"'
            echo 'type "multiplayer_only"'
            echo 'cldll "1"'
            echo 'hlversion "1111"'
            echo 'nomodels "1"'
            echo 'nohimodel "1"'
            echo 'mpentity "info_player_start"'
            echo 'gamedll "dlls\mp.dll"'
            echo 'gamedll_linux "addons/metamod/metamod_i386.so"'
            echo 'gamedll_osx "dlls/cs.dylib"'
            echo 'trainmap "tr_1"'
            echo 'edicts "1800"'
          } > merged/cstrike/liblist.gam
          
          # Generate random SteamIdHashSalt
          RANDOM_SALT=$(openssl rand -hex 32)
          if [ -f merged/cstrike/reunion.cfg ]; then
            sed -i "s/^SteamIdHashSalt =.*/SteamIdHashSalt = ${RANDOM_SALT}/" merged/cstrike/reunion.cfg
          fi
          
          echo "Merged files:"
          find merged -type f | head -50

      - name: Merge source archives
        run: |
          mkdir -p all-sources
          
          for zip in source-downloads/*-source.zip; do
            if [ -f "$zip" ]; then
              name=$(basename "$zip" -source.zip)
              mkdir -p "all-sources/$name"
              unzip -o "$zip" -d "all-sources/$name/"
            fi
          done
          
          # Add AMX Mod X other game directories to source
          if [ -d amxmodx_other_games ]; then
            mkdir -p all-sources/amxmodx-other-games
            mv amxmodx_other_games/* all-sources/amxmodx-other-games/
            rmdir amxmodx_other_games
          fi
          
          # Generate BUILD_INFO.txt
          {
            echo "=== CS Server Build Source Archive ==="
            echo "Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Run Number: ${{ github.event.client_payload.run_number }}"
            echo ""
            echo "=== Component Versions ==="
            echo "ReHLDS: ${{ github.event.client_payload.rehlds_version }}"
            echo "ReGameDLL: ${{ github.event.client_payload.regamedll_version }}"
            echo "Metamod-R: ${{ github.event.client_payload.metamod_version }}"
            echo "ReAPI: ${{ github.event.client_payload.reapi_version }}"
            echo "ReUnion: ${{ github.event.client_payload.reunion_version }}"
            echo "ReVoice: ${{ github.event.client_payload.revoice_version }}"
            echo "AMX Mod X: latest"
            echo "AmxxEasyHttp: latest"
            echo ""
            echo "=== Additional Content ==="
            echo "amxmodx-other-games/: AMX Mod X support for other games (dod, esf, ns, tfc, ts)"
          } > all-sources/BUILD_INFO.txt
          
          echo "Source archives:"
          ls -la all-sources/

      - name: Create encrypted zip files
        env:
          ZIP_PASSWORD: ${{ secrets.ZIP_PASSWORD }}
        run: |
          # Delete root appversion.h (keep component ones)
          rm -f merged/appversion.h
          
          # Encrypt merged server files
          cd merged
          7z a -tzip -p"$ZIP_PASSWORD" -mhe=on ../csserver-all-in-one.zip .
          cd ..
          
          # Encrypt source archives
          cd all-sources
          7z a -tzip -p"$ZIP_PASSWORD" -mhe=on ../csserver-all-sources.zip .
          cd ..
          
          echo "Encrypted zip files created:"
          ls -la *.zip

      - name: Get Release upload URL
        id: get_upload_url
        env:
          GAR_REPO_TOKEN: ${{ secrets.GAR_REPO_TOKEN }}
        run: |
          RELEASE_ID="${{ github.event.client_payload.release_id }}"
          
          UPLOAD_URL=$(curl -s \
            -H "Authorization: token $GAR_REPO_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/fullcone/gar/releases/$RELEASE_ID" \
            | jq -r '.upload_url' | sed 's/{?name,label}//')
          
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Upload encrypted files to Release
        env:
          GAR_REPO_TOKEN: ${{ secrets.GAR_REPO_TOKEN }}
        run: |
          UPLOAD_URL="${{ steps.get_upload_url.outputs.upload_url }}"
          
          echo "Uploading csserver-all-in-one.zip..."
          curl -s -X POST \
            -H "Authorization: token $GAR_REPO_TOKEN" \
            -H "Content-Type: application/zip" \
            "${UPLOAD_URL}?name=csserver-all-in-one.zip" \
            --data-binary @csserver-all-in-one.zip
          
          echo "Uploading csserver-all-sources.zip..."
          curl -s -X POST \
            -H "Authorization: token $GAR_REPO_TOKEN" \
            -H "Content-Type: application/zip" \
            "${UPLOAD_URL}?name=csserver-all-sources.zip" \
            --data-binary @csserver-all-sources.zip

      - name: Publish Release (remove draft)
        env:
          GAR_REPO_TOKEN: ${{ secrets.GAR_REPO_TOKEN }}
        run: |
          RELEASE_ID="${{ github.event.client_payload.release_id }}"
          
          RELEASE_BODY="CS Server Build #${{ github.event.client_payload.run_number }}
          
          Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Components
          | Component | Version |
          |-----------|---------|
          | ReHLDS | ${{ github.event.client_payload.rehlds_version }} |
          | ReGameDLL | ${{ github.event.client_payload.regamedll_version }} |
          | Metamod-R | ${{ github.event.client_payload.metamod_version }} |
          | ReAPI | ${{ github.event.client_payload.reapi_version }} |
          | ReUnion | ${{ github.event.client_payload.reunion_version }} |
          | ReVoice | ${{ github.event.client_payload.revoice_version }} |
          | AMX Mod X | latest |
          | AmxxEasyHttp | latest |
          
          ## Downloads
          - **csserver-all-in-one.zip** - Merged complete server files (encrypted)
          - **csserver-all-sources.zip** - All source archives (encrypted)
          - Other zip files are individual component builds (unencrypted)
          
          > Note: Encrypted files require password to extract
          
          # Update Release info and publish (draft: false)
          curl -s -X PATCH \
            -H "Authorization: token $GAR_REPO_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/fullcone/gar/releases/$RELEASE_ID" \
            -d "{
              \"body\": $(echo "$RELEASE_BODY" | jq -Rs .),
              \"draft\": false
            }"
          
          echo ""
          echo "=== Release published successfully ==="
          echo "https://github.com/fullcone/gar/releases/tag/${{ github.event.client_payload.release_tag }}"
